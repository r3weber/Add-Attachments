"""
Example: we have a folder of digital photographs of features from the field; the photos
are named according to the name given to the point in Avenza pdf. Let's add
these photos to a feature class as attachments.
"""

import arcpy
import os
import sys

#set up variables take user inputs
out_FGDB = arcpy.GetParameterAsText(0)
in_shapeFile = arcpy.GetParameterAsText(1)
picFolder = arcpy.GetParameterAsText(2)
out_Featureclass = (os.path.basename(in_shapeFile[:-4]))
mainDataset = os.path.join(out_FGDB, out_Featureclass)
inputField = "Photos"
fc = in_shapeFile

#update values in Photos field of exported shp so match table is set up correctly
cursor = arcpy.UpdateCursor(fc)
for row in cursor:
    if "images/" in row.getValue(inputField):
        #remove 'images/' from Photos field values
        row.setValue(inputField, row.getValue(inputField)[7:])
        cursor.updateRow(row)
    else:
        continue

        
#create matchtable           
matchTable = os.path.join(out_FGDB, "matchtable")


#import shapefile and create FC
arcpy.FeatureClassToFeatureClass_conversion(in_shapeFile, (out_FGDB), (out_Featureclass))


#generate match table

arcpy.GenerateAttachmentMatchTable_management(in_dataset= (mainDataset),
                                                  in_folder=(picFolder),
                                                  out_match_table=(matchTable),
                                                  in_key_field=(inputField), in_file_filter="",
                                                  in_use_relative_paths="RELATIVE")

#enable attachements on existing FC
arcpy.EnableAttachments_management(in_dataset=(mainDataset))

#Add attachements to existing FC using match table
arcpy.AddAttachments_management(in_dataset=(mainDataset), in_join_field="OBJECTID", in_match_table=(matchTable),
                                    in_match_join_field="MATCHID", in_match_path_field="FILENAME",
                                    in_working_folder=(picFolder))

print "Features and Attachments added successfully"
#delete matchtable as it serves no use except to get in the way once the attachments have been added
arcpy.Delete_management(matchTable)
print "Removed Match Table"
